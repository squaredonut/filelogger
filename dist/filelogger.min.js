/*!
 * fileLogger
 * Copyright 2015 Peter Bakondy https://github.com/pbakondy
 * See LICENSE in this repository for license information
 */
!function(){angular.module("fileLogger",["ngCordova.plugins.file"]).factory("$fileLogger",["$q","$window","$cordovaFile","$timeout","$filter",function(e,o,r,a,t){"use strict";function n(){return!o.cordova&&!o.PhoneGap}function i(e){angular.isString(e)?(e=e.toUpperCase(),-1===j.indexOf(e)&&(e="INFO")):e="INFO";for(var o,r=new Date,a=m?t("date")(r,m,F):r.toJSON(),i=Array.prototype.slice.call(arguments,1),c=[a,e],s=0;s<i.length;s++)if(angular.isArray(i[s])){o="[Array]";try{o=JSON.stringify(i[s])}catch(f){}c.push(o)}else if(angular.isObject(i[s])){o="[Object]";try{o=JSON.stringify(i[s])}catch(f){}c.push(o)}else c.push(i[s]);if(n()){if(i.unshift(a),angular.isObject(console)&&angular.isFunction(console.log))switch(e){case"DEBUG":angular.isFunction(console.debug)?console.debug.apply(console,i):console.log.apply(console,i);break;case"INFO":angular.isFunction(console.debug)?console.info.apply(console,i):console.log.apply(console,i);break;case"WARN":angular.isFunction(console.debug)?console.warn.apply(console,i):console.log.apply(console,i);break;case"ERROR":angular.isFunction(console.debug)?console.error.apply(console,i):console.log.apply(console,i);break;default:console.log.apply(console,i)}}else console.log(c.join(" "));b.push({message:c.join(" ")+"\n"}),D||l()}function l(){if(!b.length)return void(D=!1);D=!0;var e=b.shift();c(e.message).then(function(){a(function(){l()})},function(){a(function(){l()})})}function c(a){var t=e.defer();if(n())o.localStorage[S]||(o.localStorage[S]=""),o.localStorage[S]+=a,t.resolve();else{if(!cordova&&!cordova.file&&!cordova.file.dataDirectory)return t.reject("cordova.file.dataDirectory is not available yet."),t.promise;r.checkFile(cordova.file.dataDirectory,S).then(function(e){e.size>5e6?r.writeFile(cordova.file.dataDirectory,S,a,!0).then(function(){t.resolve()},function(e){t.reject(e)}):r.writeExistingFile(cordova.file.dataDirectory,S,a).then(function(){t.resolve()},function(e){t.reject(e)})},function(){r.writeFile(cordova.file.dataDirectory,S,a,!0).then(function(){t.resolve()},function(e){t.reject(e)})})}return t.promise}function s(){var a=e.defer();if(n())a.resolve(o.localStorage[S]);else{if(!cordova&&!cordova.file&&!cordova.file.dataDirectory)return a.reject("cordova.file.dataDirectory is not available yet."),a.promise;r.readAsText(cordova.file.dataDirectory,S).then(function(e){a.resolve(e)},function(e){a.reject(e)})}return a.promise}function f(){var a=e.defer();if(n())o.localStorage.removeItem(S),a.resolve();else{if(!cordova&&!cordova.file&&!cordova.file.dataDirectory)return a.reject("cordova.file.dataDirectory is not available yet."),a.promise;r.removeFile(cordova.file.dataDirectory,S).then(function(e){a.resolve(e)},function(e){a.reject(e)})}return a.promise}function u(e){return angular.isString(e)&&e.length>0?(S=e,!0):!1}function d(e,o){if(!angular.isUndefined(e)&&!angular.isString(e))throw new TypeError("format parameter must be a string or undefined");if(!angular.isUndefined(o)&&!angular.isString(o))throw new TypeError("timezone parameter must be a string or undefined");m=e,F=o}function g(){var a=e.defer();if(n())a.resolve({name:S,localURL:"localStorage://localhost/"+S,type:"text/plain",size:o.localStorage[S]?o.localStorage[S].length:0});else{if(!cordova&&!cordova.file&&!cordova.file.dataDirectory)return a.reject("cordova.file.dataDirectory is not available yet."),a.promise;r.checkFile(cordova.file.dataDirectory,S).then(function(e){e.file(a.resolve,a.reject)},a.reject)}return a.promise}function p(){var e=Array.prototype.slice.call(arguments,0);e.unshift("DEBUG"),i.apply(void 0,e)}function v(){var e=Array.prototype.slice.call(arguments,0);e.unshift("INFO"),i.apply(void 0,e)}function y(){var e=Array.prototype.slice.call(arguments,0);e.unshift("WARN"),i.apply(void 0,e)}function h(){var e=Array.prototype.slice.call(arguments,0);e.unshift("ERROR"),i.apply(void 0,e)}var m,F,b=[],D=!1,j=["DEBUG","INFO","WARN","ERROR"],S="messages.log";return{log:i,getLogfile:s,deleteLogfile:f,setStorageFilename:u,setTimestampFormat:d,checkFile:g,debug:p,info:v,warn:y,error:h}}])}();